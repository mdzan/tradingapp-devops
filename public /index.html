<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeJournal Pro 2026 | Analytics</title>
    
    <!-- External Assets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for Visual Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 
      =========================================
      STYLESHEET (CSS) - Professional Theming
      =========================================
    -->
    <style>
        /* DEFAULT DARK THEME VARIABLES */
        :root {
            --bg-main: #060910; 
            --bg-card: #0f172a; 
            --bg-hover: #1e293b;
            --text-main: #f8fafc; 
            --text-muted: #64748b;
            --primary: #6366f1; 
            --primary-hover: #818cf8;
            --profit: #10b981; 
            --profit-bg: rgba(16, 185, 129, 0.1);
            --loss: #f43f5e; 
            --loss-bg: rgba(244, 63, 94, 0.1);
            --border: #1e293b;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        /* LIGHT THEME OVERRIDES */
        body.light-theme {
            --bg-main: #f8fafc; 
            --bg-card: #ffffff; 
            --bg-hover: #f1f5f9;
            --text-main: #0f172a; 
            --text-muted: #64748b;
            --primary: #4f46e5; 
            --primary-hover: #4338ca;
            --profit: #10b981; 
            --loss: #ef4444; 
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', system-ui, sans-serif; transition: background-color 0.3s, border-color 0.3s, color 0.3s; }
        body { background-color: var(--bg-main); color: var(--text-main); min-height: 100vh; padding: 20px; padding-bottom: 80px; }
        .container { max-width: 1440px; margin: 0 auto; width: 100%; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid var(--border); margin-bottom: 30px; }
        .logo { font-size: 1.6rem; font-weight: 900; display: flex; align-items: center; gap: 12px; letter-spacing: -1px; }
        .logo i { color: var(--primary); }

        /* Theme Toggle Button */
        .theme-toggle {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-main);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: 0.2s;
        }
        .theme-toggle:hover { background: var(--bg-hover); transform: translateY(-2px); }

        /* Stats Bar - Enhanced Visuals */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-card); padding: 24px; border-radius: 20px; border: 1px solid var(--border); box-shadow: var(--shadow); position: relative; overflow: hidden; display: flex; align-items: center; justify-content: space-between; }
        .stat-content { flex: 1; }
        .stat-label { color: var(--text-muted); font-size: 0.8rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .stat-value { font-size: 2rem; font-weight: 900; }
        
        .stat-visual { width: 120px; height: 70px; display: flex; align-items: center; justify-content: center; }

        /* Dashboard Grid */
        .dashboard-grid { display: grid; grid-template-columns: 380px 1fr; gap: 24px; }
        @media (max-width: 1100px) { .dashboard-grid { grid-template-columns: 1fr; } }

        .card { background: var(--bg-card); padding: 24px; border-radius: 24px; border: 1px solid var(--border); margin-bottom: 24px; box-shadow: var(--shadow); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
        .card-title { font-size: 0.85rem; font-weight: 800; display: flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Performance Chart */
        .chart-container { height: 280px; width: 100%; margin-top: 10px; }

        /* Calendar */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .weekday { text-align: center; color: var(--text-muted); font-size: 0.7rem; font-weight: 900; padding-bottom: 12px; }
        .day { aspect-ratio: 1.2; background: var(--bg-main); border-radius: 12px; padding: 8px; border: 1px solid transparent; cursor: pointer; display: flex; flex-direction: column; transition: 0.2s; min-height: 85px; position: relative; }
        .day:hover { border-color: var(--primary); transform: scale(1.03); background: var(--bg-hover); z-index: 5; }
        .day.today { border: 2px solid var(--primary); background: var(--bg-hover); }
        .day-num { font-size: 0.75rem; font-weight: 800; color: var(--text-muted); }
        
        .pnl-tag { font-size: 0.65rem; font-weight: 900; margin-top: auto; text-align: center; padding: 2px; border-radius: 6px; }
        .win { color: var(--profit); background: var(--profit-bg); }
        .loss { color: var(--loss); background: var(--loss-bg); }

        /* Trade Count Badge */
        .trade-count-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.6rem;
            font-weight: 800;
            background: var(--bg-hover);
            color: var(--text-muted);
            padding: 2px 6px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        /* Note Preview Style */
        .day-note-preview {
            font-size: 0.6rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 4px;
            font-style: italic;
            max-width: 100%;
        }

        /* Forms & Modals */
        .form-group { margin-bottom: 15px; }
        label { display: block; color: var(--text-muted); margin-bottom: 8px; font-size: 0.75rem; font-weight: 700; }
        input, select, textarea { width: 100%; background: var(--bg-main); border: 1px solid var(--border); color: var(--text-main); padding: 14px; border-radius: 12px; font-size: 0.95rem; outline: none; transition: 0.2s; }
        textarea { resize: none; height: 80px; font-family: inherit; }
        input:focus, textarea:focus { border-color: var(--primary); }
        
        .btn { width: 100%; padding: 12px; border-radius: 12px; font-weight: 800; cursor: pointer; border: none; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        .btn-outline:hover { background: var(--bg-hover); color: var(--text-main); }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(12px); }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-card); padding: 32px; border-radius: 24px; width: 95%; max-width: 480px; border: 1px solid var(--border); max-height: 90vh; overflow-y: auto; }

        .ticker { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-card); border-top: 1px solid var(--border); padding: 12px 0; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; font-weight: 700; color: var(--text-muted); }
        
        /* Tooltip style for Risk Lab */
        .risk-result { background: var(--bg-main); padding: 15px; border-radius: 12px; border-left: 4px solid var(--primary); margin-top: 15px; font-size: 0.85rem; }

        /* Daily List in Modal */
        .daily-list { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .daily-item { background: var(--bg-main); padding: 10px; border-radius: 10px; margin-bottom: 8px; font-size: 0.85rem; border: 1px solid var(--border); }
        .daily-item-meta { display: flex; justify-content: space-between; font-weight: 800; margin-bottom: 4px; }
        .daily-note { color: var(--text-muted); font-style: italic; font-size: 0.8rem; line-height: 1.4; border-top: 1px solid var(--border); margin-top: 5px; padding-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <div class="logo"><i class="fa-solid fa-wave-square"></i> TradeJournal <span style="color:var(--primary)">PRO</span></div>
        <div style="display:flex; align-items:center; gap:15px;">
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                <i class="fa-solid fa-moon" id="theme-icon"></i>
            </button>
            <div style="font-size: 0.75rem; color: var(--profit); font-weight: 800;"><i class="fa-solid fa-circle"></i> SYSTEM LIVE</div>
        </div>
    </header>

    <!-- KEY STATS - Enhanced with Visual Analytics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-content">
                <div class="stat-label">Net Realized P&L</div>
                <div class="stat-value" id="total-pnl">$0.00</div>
            </div>
            <div class="stat-visual">
                <canvas id="pnlSparkline"></canvas>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-content">
                <div class="stat-label">Win Accuracy</div>
                <div class="stat-value" id="win-rate">0%</div>
            </div>
            <div class="stat-visual">
                <canvas id="winGauge"></canvas>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-content">
                <div class="stat-label">System Performance</div>
                <div class="stat-value text-profit" style="font-size: 1.4rem; padding-top: 5px;">OPTIMIZED</div>
                <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 4px;">Risk Thresholds within limit</div>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <!-- LEFT: ANALYTICS & TOOLS -->
        <div class="sidebar">
            <!-- A+ FEATURE: PERFORMANCE GRAPH -->
            <div class="card">
                <div class="card-header"><div class="card-title"><i class="fa-solid fa-chart-area"></i> Equity Curve (SGD)</div></div>
                <div class="chart-container">
                    <canvas id="pnlChart"></canvas>
                </div>
            </div>

            <!-- A+ FEATURE: RISK MANAGEMENT LAB -->
            <div class="card">
                <div class="card-header"><div class="card-title"><i class="fa-solid fa-shield-halved"></i> Risk & Sizing Lab</div></div>
                <div class="form-group">
                    <label>Account Balance (SGD)</label>
                    <input type="number" id="risk-balance" placeholder="10000">
                </div>
                <div class="form-group">
                    <label>Risk Per Trade (%)</label>
                    <input type="number" id="risk-percent" placeholder="1" step="0.1">
                </div>
                <div class="form-group">
                    <label>Stop Loss (Points/Pips)</label>
                    <input type="number" id="risk-sl" placeholder="50">
                </div>
                <button class="btn btn-primary" onclick="calculatePositionSize()">Calculate Risk</button>
                <div id="risk-output" class="risk-result" style="display:none;">
                    <div style="color:var(--text-muted); margin-bottom: 5px;">Max Risk Amount: <span id="risk-amt" style="color:var(--loss)">$0</span></div>
                    <div style="font-weight: 800;">Recommended Size: <span id="risk-pos" style="color:var(--primary)">0 Units</span></div>
                </div>
            </div>

            <!-- CURRENCY TOOL -->
            <div class="card">
                <div class="card-header"><div class="card-title"><i class="fa-solid fa-calculator"></i> FX Evaluator</div></div>
                <div class="form-group"><input type="number" id="qc-amount" placeholder="Input Units (e.g. 100)"></div>
                <div style="display:flex; gap:8px; margin-bottom:15px;">
                    <select id="qc-from" class="fiat-list"></select>
                    <select id="qc-to" class="fiat-list"></select>
                </div>
                <button class="btn btn-outline" onclick="runQuickConvert()">Get Valuation</button>
                <div id="qc-result" style="margin-top:20px; text-align:center; font-size: 1.3rem; font-weight: 900; color: var(--profit);"></div>
            </div>
        </div>

        <!-- RIGHT: JOURNAL -->
        <div class="main-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fa-solid fa-calendar"></i> Trading Log 2026</div>
                    <div style="display:flex; gap:12px; align-items:center;">
                        <button class="btn btn-outline" style="width:30px; height:30px; padding:0;" onclick="exportToCSV()" title="Export CSV"><i class="fa-solid fa-file-export"></i></button>
                        <div style="width: 1px; height: 20px; background: var(--border);"></div>
                        <button class="btn btn-outline" style="width:30px; height:30px; padding:0;" onclick="changeMonth(-1)"><i class="fa-solid fa-angle-left"></i></button>
                        <span id="current-month" style="font-weight: 900; width:140px; text-align:center;">...</span>
                        <button class="btn btn-outline" style="width:30px; height:30px; padding:0;" onclick="changeMonth(1)"><i class="fa-solid fa-angle-right"></i></button>
                    </div>
                </div>
                <div class="calendar-grid">
                    <div class="weekday">SUN</div><div class="weekday">MON</div><div class="weekday">TUE</div><div class="weekday">WED</div><div class="weekday">THU</div><div class="weekday">FRI</div><div class="weekday">SAT</div>
                </div>
                <div class="calendar-grid" id="calendar-days"></div>
            </div>
            
            <div class="card">
                <div class="card-header"><div class="card-title"><i class="fa-solid fa-circle-info"></i> Instructions</div></div>
                <p style="color:var(--text-muted); font-size: 0.9rem; line-height: 1.6;">
                    Select any date on the 2026 calendar to record a trade. The <strong>badge in the top-right</strong> of each cell indicates the total number of trades taken that day. Use the <strong>Export</strong> button to download your full ledger as a CSV.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- ENTRY MODAL -->
<div class="modal" id="entry-modal">
    <div class="modal-content">
        <h3 style="margin-bottom:20px; font-weight: 900;" id="modal-title"><i class="fa-solid fa-pen-nib"></i> Log Trade</h3>
        
        <!-- Daily Activity Section -->
        <div id="daily-log-section" style="display:none;">
            <label id="daily-log-label" style="color: var(--primary); margin-bottom: 10px; display: block;">Today's Entries</label>
            <div id="daily-entries-list" class="daily-list"></div>
        </div>

        <form id="trade-form">
            <input type="date" id="trade-date" readonly style="margin-bottom:12px; background: var(--bg-hover); border: none;">
            
            <div class="form-group">
                <label>Currency Used</label>
                <select id="asset-choice" class="fiat-list"></select>
            </div>
            
            <div class="form-group">
                <label>P&L Units</label>
                <input type="number" id="pnl-amount" placeholder="e.g. 500 or -200" step="any" required>
            </div>

            <div class="form-group">
                <label>Notes / Strategy</label>
                <textarea id="trade-note" placeholder="Reason for trade? Emotions? Setup?"></textarea>
            </div>

            <div style="display:flex; gap:10px;">
                <button type="submit" class="btn btn-primary">Save to Ledger</button>
                <button type="button" class="btn btn-outline" style="width:100%; border-radius:12px;" onclick="closeModal()">Close</button>
            </div>
        </form>
    </div>
</div>

<div class="ticker"><marquee id="master-ticker">Establishing secure data stream with global exchange markets...</marquee></div>

<!-- 
  =========================================
  LOGIC (JAVASCRIPT)
  =========================================
-->
<script>
    const FIATS = [
        { code: "USD", name: "US Dollar" }, { code: "SGD", name: "SG Dollar" },
        { code: "EUR", name: "Euro" }, { code: "GBP", name: "British Pound" },
        { code: "JPY", name: "Japanese Yen" }, { code: "MYR", name: "Malaysian Ringgit" },
        { code: "AUD", name: "Australian Dollar" }
    ];

    const API_URL = 'https://open.er-api.com/v6/latest/USD';
    let currentRates = { "USD": 1, "SGD": 1.35 };
    let trades = JSON.parse(localStorage.getItem('trade_journal_2026_v2')) || [];
    let viewDate = new Date(2026, new Date().getMonth(), 1);
    let pnlChart = null; 
    let sparkline = null;
    let gauge = null;

    document.addEventListener('DOMContentLoaded', async () => {
        initTheme(); 
        setupDropdowns();
        await syncMarkets();
        renderCalendar();
        updateStats();
        initChart(); 
        initMiniCharts();
        setInterval(syncMarkets, 60000);
    });

    // THEME LOGIC
    function toggleTheme() {
        const body = document.body;
        const icon = document.getElementById('theme-icon');
        body.classList.toggle('light-theme');
        
        const isLight = body.classList.contains('light-theme');
        localStorage.setItem('theme_preference', isLight ? 'light' : 'dark');
        icon.className = isLight ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        
        if (pnlChart) {
            pnlChart.options.scales.y.grid.color = isLight ? '#e2e8f0' : '#1e293b';
            pnlChart.update();
        }
        updateMiniCharts();
    }

    function initTheme() {
        const savedTheme = localStorage.getItem('theme_preference');
        const icon = document.getElementById('theme-icon');
        if (savedTheme === 'light') {
            document.body.classList.add('light-theme');
            icon.className = 'fa-solid fa-sun';
        }
    }

    function setupDropdowns() {
        const selects = document.querySelectorAll('.fiat-list');
        selects.forEach(s => {
            FIATS.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.code;
                opt.textContent = `${c.code} - ${c.name}`;
                if(s.id === 'qc-to' && c.code === 'SGD') opt.selected = true;
                s.appendChild(opt);
            });
        });
    }

    async function syncMarkets() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            currentRates = data.rates;
            let ticker = "MARKET FEED :: ";
            ['SGD', 'EUR', 'GBP', 'JPY', 'MYR'].forEach(c => ticker += `${c}: ${currentRates[c].toFixed(3)} | `);
            document.getElementById('master-ticker').innerText = ticker;
            updateStats();
        } catch (e) { console.error("API Error", e); }
    }

    // --- CHART LOGIC ---
    function initChart() {
        const ctx = document.getElementById('pnlChart').getContext('2d');
        const isLight = document.body.classList.contains('light-theme');

        pnlChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ 
                label: 'Equity (SGD)', 
                data: [], 
                borderColor: '#6366f1', 
                backgroundColor: 'rgba(99, 102, 241, 0.1)', 
                fill: true, 
                tension: 0.4, 
                pointRadius: 4, 
                pointBackgroundColor: '#6366f1' 
            }]},
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 10 } } },
                    y: { grid: { color: isLight ? '#e2e8f0' : '#1e293b' }, ticks: { color: '#64748b' } }
                }
            }
        });
        updateChartData();
    }

    // --- MINI CHARTS LOGIC ---
    function initMiniCharts() {
        const sparkCtx = document.getElementById('pnlSparkline').getContext('2d');
        sparkline = new Chart(sparkCtx, {
            type: 'line',
            data: { labels: [], datasets: [{ 
                data: [], 
                borderColor: '#10b981', 
                borderWidth: 2, 
                pointRadius: 0, 
                fill: false, 
                tension: 0.4 
            }]},
            options: {
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                scales: { x: { display: false }, y: { display: false } },
                responsive: true,
                maintainAspectRatio: false
            }
        });

        const gaugeCtx = document.getElementById('winGauge').getContext('2d');
        gauge = new Chart(gaugeCtx, {
            type: 'doughnut',
            data: {
                labels: ['Wins', 'Losses'],
                datasets: [{
                    data: [0, 100],
                    backgroundColor: ['#10b981', '#f43f5e'],
                    borderWidth: 0,
                    circumference: 180,
                    rotation: 270,
                    cutout: '80%'
                }]
            },
            options: {
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                responsive: true,
                maintainAspectRatio: false
            }
        });
        updateMiniCharts();
    }

    function updateChartData() {
        if (!pnlChart) return;
        const sortedTrades = [...trades].sort((a, b) => new Date(a.date) - new Date(b.date));
        let cumulative = 0;
        const labels = [];
        const dataPoints = [];
        sortedTrades.forEach(t => {
            cumulative += (t.amt / (currentRates[t.cur] || 1)) * (currentRates['SGD'] || 1.35);
            labels.push(t.date);
            dataPoints.push(cumulative);
        });
        pnlChart.data.labels = labels;
        pnlChart.data.datasets[0].data = dataPoints;
        pnlChart.update();
    }

    function updateMiniCharts() {
        if (!sparkline || !gauge) return;
        
        // Update Sparkline
        const sortedTrades = [...trades].sort((a, b) => new Date(a.date) - new Date(b.date));
        let cumulative = 0;
        const dataPoints = sortedTrades.map(t => {
            cumulative += (t.amt / (currentRates[t.cur] || 1)) * (currentRates['SGD'] || 1.35);
            return cumulative;
        });
        sparkline.data.labels = dataPoints.map((_, i) => i);
        sparkline.data.datasets[0].data = dataPoints;
        sparkline.data.datasets[0].borderColor = cumulative >= 0 ? '#10b981' : '#f43f5e';
        sparkline.update();

        // Update Gauge
        let wins = 0;
        trades.forEach(t => { if(t.amt > 0) wins++; });
        const winPercent = trades.length ? (wins / trades.length) * 100 : 0;
        gauge.data.datasets[0].data = [winPercent, 100 - winPercent];
        gauge.update();
    }

    // --- UTILITIES ---
    function runQuickConvert() {
        const amt = parseFloat(document.getElementById('qc-amount').value);
        const from = document.getElementById('qc-from').value;
        const to = document.getElementById('qc-to').value;
        if(isNaN(amt) || !currentRates[from]) return;
        const res = (amt / currentRates[from]) * currentRates[to];
        document.getElementById('qc-result').innerText = `${to} ${res.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
    }

    function calculatePositionSize() {
        const balance = parseFloat(document.getElementById('risk-balance').value);
        const percent = parseFloat(document.getElementById('risk-percent').value);
        const sl = parseFloat(document.getElementById('risk-sl').value);
        if(isNaN(balance) || isNaN(percent) || isNaN(sl) || sl === 0) return;
        const riskAmount = balance * (percent / 100);
        const posSize = riskAmount / sl;
        document.getElementById('risk-amt').innerText = `$${riskAmount.toFixed(2)}`;
        document.getElementById('risk-pos').innerText = `${posSize.toFixed(2)} Units`;
        document.getElementById('risk-output').style.display = 'block';
    }

    function exportToCSV() {
        if(trades.length === 0) return;
        let csvContent = "data:text/csv;charset=utf-8,Date,Currency,Amount,Amount_SGD,Notes\n";
        trades.forEach(t => {
            const sgd = (t.amt / (currentRates[t.cur] || 1)) * (currentRates['SGD'] || 1.35);
            const cleanNote = (t.note || "").replace(/"/g, '""');
            csvContent += `${t.date},${t.cur},${t.amt},${sgd.toFixed(2)},"${cleanNote}"\n`;
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "trade_journal_2026_export.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function changeMonth(step) {
        const next = new Date(viewDate.getFullYear(), viewDate.getMonth() + step, 1);
        if(next.getFullYear() !== 2026) return;
        viewDate = next;
        renderCalendar();
    }

    function renderCalendar() {
        const grid = document.getElementById('calendar-days');
        grid.innerHTML = '';
        const y = viewDate.getFullYear();
        const m = viewDate.getMonth();
        document.getElementById('current-month').innerText = viewDate.toLocaleString('default', { month: 'long', year: 'numeric' });
        const firstDay = new Date(y, m, 1).getDay();
        const daysInMonth = new Date(y, m + 1, 0).getDate();
        for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
        for(let i=1; i<=daysInMonth; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'day';
            const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const dayTrades = trades.filter(t => t.date === dStr);
            dayDiv.innerHTML = `<span class="day-num">${i}</span>`;
            if(dayTrades.length > 0) {
                const countBadge = document.createElement('div');
                countBadge.className = 'trade-count-badge';
                countBadge.innerText = `${dayTrades.length} ${dayTrades.length === 1 ? 'trade' : 'trades'}`;
                dayDiv.appendChild(countBadge);
                const firstWithNote = dayTrades.reverse().find(t => t.note);
                if (firstWithNote) {
                    const notePreview = document.createElement('div');
                    notePreview.className = 'day-note-preview';
                    notePreview.innerText = firstWithNote.note;
                    dayDiv.appendChild(notePreview);
                }
                const sgdTotal = dayTrades.reduce((acc, t) => acc + ((t.amt / (currentRates[t.cur] || 1)) * (currentRates['SGD'] || 1.35)), 0);
                const tag = document.createElement('div');
                tag.className = `pnl-tag ${sgdTotal >= 0 ? 'win' : 'loss'}`;
                tag.innerText = `$${Math.abs(sgdTotal).toFixed(0)}`;
                dayDiv.appendChild(tag);
            }
            if(y === new Date().getFullYear() && m === new Date().getMonth() && i === new Date().getDate()) dayDiv.classList.add('today');
            dayDiv.onclick = () => openModal(dStr);
            grid.appendChild(dayDiv);
        }
    }

    const modal = document.getElementById('entry-modal');
    function openModal(d) { 
        modal.classList.add('active'); 
        document.getElementById('trade-date').value = d;
        document.getElementById('trade-note').value = ""; 
        const dayTrades = trades.filter(t => t.date === d);
        const section = document.getElementById('daily-log-section');
        const list = document.getElementById('daily-entries-list');
        const label = document.getElementById('daily-log-label');
        if (dayTrades.length > 0) {
            section.style.display = 'block';
            label.innerText = `Daily History (${dayTrades.length} trades taken)`;
            list.innerHTML = dayTrades.map(t => `
                <div class="daily-item">
                    <div class="daily-item-meta">
                        <span>${t.amt} ${t.cur}</span>
                        <span class="${t.amt >= 0 ? 'win' : 'loss'}">$${((t.amt / (currentRates[t.cur] || 1)) * (currentRates['SGD'] || 1.35)).toFixed(2)} SGD</span>
                    </div>
                    ${t.note ? `<div class="daily-note">${t.note}</div>` : ''}
                </div>
            `).join('');
        } else { section.style.display = 'none'; }
    }
    function closeModal() { modal.classList.remove('active'); }

    document.getElementById('trade-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const date = document.getElementById('trade-date').value;
        const cur = document.getElementById('asset-choice').value;
        const amt = parseFloat(document.getElementById('pnl-amount').value);
        const note = document.getElementById('trade-note').value;
        trades.push({ date, cur, amt, note, id: Date.now() });
        localStorage.setItem('trade_journal_2026_v2', JSON.stringify(trades));
        closeModal(); renderCalendar(); updateStats(); updateChartData(); updateMiniCharts();
    });

    function updateStats() {
        let total = 0, wins = 0;
        trades.forEach(t => {
            const sgd = (t.amt / (currentRates[t.cur] || 1)) * (currentRates['SGD'] || 1.35);
            total += sgd; if(sgd > 0) wins++;
        });
        document.getElementById('total-pnl').innerText = `$${total.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('total-pnl').className = `stat-value ${total >= 0 ? 'text-profit' : 'text-loss'}`;
        document.getElementById('win-rate').innerText = trades.length ? Math.round((wins/trades.length)*100) + '%' : '0%';
    }
</script>
</body>
</html>
